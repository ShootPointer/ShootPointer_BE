


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RankingReader</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.midas.shootpointer.batch.reader.ranking</a>
</div>

<h1>Coverage Summary for Class: RankingReader (com.midas.shootpointer.batch.reader.ranking)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RankingReader</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
</tr>
  <tr>
    <td class="name">RankingReader$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">RankingReader$$SpringCGLIB$$FastClass$$0</td>
  </tr>
  <tr>
    <td class="name">RankingReader$$SpringCGLIB$$FastClass$$1</td>
  </tr>
  <tr>
    <td class="name">RankingReader$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.midas.shootpointer.batch.reader.ranking;
&nbsp;
&nbsp;import com.midas.shootpointer.batch.dto.HighlightWithMemberDto;
&nbsp;import com.midas.shootpointer.domain.ranking.dto.RankingType;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.batch.core.configuration.annotation.StepScope;
&nbsp;import org.springframework.batch.item.database.JdbcPagingItemReader;
&nbsp;import org.springframework.batch.item.database.Order;
&nbsp;import org.springframework.batch.item.database.PagingQueryProvider;
&nbsp;import org.springframework.batch.item.database.support.PostgresPagingQueryProvider;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;
&nbsp;import javax.sql.DataSource;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;/**
&nbsp; * 조건에 맞는 데이터만 read
&nbsp; */
&nbsp;@Configuration
&nbsp;@RequiredArgsConstructor
&nbsp;public class RankingReader{
&nbsp;    /**
&nbsp;     * Page Size
&nbsp;     */
&nbsp;    private final int FETCH_SIZE=1_000;
&nbsp;    private final DataSource dataSource;
&nbsp;
&nbsp;    @Bean
&nbsp;    @StepScope
&nbsp;    public JdbcPagingItemReader&lt;HighlightWithMemberDto&gt; highlightReader(
&nbsp;            @Value(&quot;#{jobParameters[&#39;rankingType&#39;]}&quot;)RankingType rankingType,
&nbsp;            @Value(&quot;#{jobParameters[&#39;end&#39;]}&quot;)String endStr
&nbsp;            ){
&nbsp;        /**
&nbsp;         * 기간 계산 - weekly / monthly / daily
&nbsp;         */
<b class="nc">&nbsp;        LocalDateTime end=LocalDateTime.parse(endStr);</b>
<b class="nc">&nbsp;        LocalDateTime begin=end;</b>
&nbsp;
<b class="nc">&nbsp;        switch (rankingType){</b>
<b class="nc">&nbsp;            case DAILY -&gt; begin=end.minusDays(1);</b>
<b class="nc">&nbsp;            case WEEKLY -&gt; begin=end.minusDays(7);</b>
<b class="nc">&nbsp;            case MONTHLY -&gt; begin=end.minusMonths(1);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        JdbcPagingItemReader&lt;HighlightWithMemberDto&gt; rankingReader=new JdbcPagingItemReader&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        rankingReader.setName(&quot;rankingReader&quot;);</b>
<b class="nc">&nbsp;        rankingReader.setDataSource(dataSource);</b>
<b class="nc">&nbsp;        rankingReader.setFetchSize(FETCH_SIZE);</b>
<b class="nc">&nbsp;        rankingReader.setQueryProvider(pagingQueryProvider());</b>
<b class="nc">&nbsp;        rankingReader.setParameterValues(Map.of(</b>
&nbsp;                &quot;end&quot;,end,
&nbsp;                &quot;begin&quot;,begin
&nbsp;        ));
&nbsp;
&nbsp;        //highlight_with_member mapping
<b class="nc">&nbsp;        rankingReader.setRowMapper(((rs, rowNum) -&gt; HighlightWithMemberDto.builder()</b>
<b class="nc">&nbsp;                .memberId((UUID) rs.getObject(&quot;member_id&quot;))</b>
<b class="nc">&nbsp;                .memberName(rs.getString(&quot;member_name&quot;))</b>
<b class="nc">&nbsp;                .threePointTotal(rs.getInt(&quot;three_point_total&quot;))</b>
<b class="nc">&nbsp;                .twoPointTotal(rs.getInt(&quot;two_point_total&quot;))</b>
<b class="nc">&nbsp;                .totalScore(rs.getInt(&quot;total_score&quot;))</b>
<b class="nc">&nbsp;                .build()</b>
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        return rankingReader;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 커스텀 PagingQueryProvider
&nbsp;     */
&nbsp;    private PagingQueryProvider pagingQueryProvider(){
<b class="nc">&nbsp;        PostgresPagingQueryProvider queryProvider=new PostgresPagingQueryProvider();</b>
&nbsp;        //Highlight Member 데이터 조회
&nbsp;
&nbsp;        /**
&nbsp;         *  1. 시간 조건
&nbsp;         *     + is_selected = true
&nbsp;         *     + is_aggregation_agreed = true
&nbsp;         */
<b class="nc">&nbsp;        queryProvider.setSelectClause(&quot;&quot;&quot;</b>
&nbsp;                SELECT
&nbsp;                    m.member_id,
&nbsp;                    m.member_name,
&nbsp;                    SUM(h.two_point_count * 2) AS two_point_total,
&nbsp;                    SUM(h.three_point_count * 3) AS three_point_total,
&nbsp;                    (SUM(h.two_point_count * 2) + SUM(h.three_point_count * 3)) AS total_score,
&nbsp;                    MAX(h.created_at) AS max_created_at
&nbsp;                &quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        queryProvider.setFromClause(&quot;&quot;&quot;</b>
&nbsp;                FROM
&nbsp;                    highlight AS h
&nbsp;                JOIN
&nbsp;                    member AS m ON m.member_id = h.member_id
&nbsp;                &quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        queryProvider.setWhereClause(&quot;&quot;&quot;</b>
&nbsp;                WHERE
&nbsp;                  m.is_aggregation_agreed = true
&nbsp;                  AND h.is_selected = true
&nbsp;                  AND h.created_at BETWEEN :begin AND :end
&nbsp;                &quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        queryProvider.setGroupClause(&quot;&quot;&quot;</b>
&nbsp;                GROUP BY m.member_id, m.member_name
&nbsp;                &quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        queryProvider.setSortKeys(Map.of(&quot;max_created_at&quot;, Order.DESCENDING));</b>
&nbsp;
<b class="nc">&nbsp;        return queryProvider;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-23 11:21</div>
</div>
</body>
</html>
