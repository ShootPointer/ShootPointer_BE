


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PostCustomElasticSearchRepositoryImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.midas.shootpointer.domain.post.repository</a>
</div>

<h1>Coverage Summary for Class: PostCustomElasticSearchRepositoryImpl (com.midas.shootpointer.domain.post.repository)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PostCustomElasticSearchRepositoryImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.midas.shootpointer.domain.post.repository;
&nbsp;
&nbsp;import co.elastic.clients.elasticsearch._types.SortOptions;
&nbsp;import co.elastic.clients.elasticsearch._types.SortOrder;
&nbsp;import com.midas.shootpointer.domain.post.dto.response.PostSort;
&nbsp;import com.midas.shootpointer.domain.post.entity.PostDocument;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.context.annotation.Profile;
&nbsp;import org.springframework.data.elasticsearch.client.elc.NativeQuery;
&nbsp;import org.springframework.data.elasticsearch.client.elc.NativeQueryBuilder;
&nbsp;import org.springframework.data.elasticsearch.core.ElasticsearchOperations;
&nbsp;import org.springframework.data.elasticsearch.core.SearchHits;
&nbsp;import org.springframework.data.elasticsearch.core.query.Criteria;
&nbsp;import org.springframework.data.elasticsearch.core.query.CriteriaQuery;
&nbsp;
&nbsp;import java.util.List;
&nbsp;
&nbsp;
&nbsp;@RequiredArgsConstructor
&nbsp;@Profile(&quot;es&quot;)
&nbsp;public class PostCustomElasticSearchRepositoryImpl implements PostCustomElasticSearchRepository {
&nbsp;    private final ElasticsearchOperations operations;
&nbsp;
&nbsp;    //제목 가중치
&nbsp;    private final float TITLE_WEIGHT = 40f;
&nbsp;    //내용 가중치
&nbsp;    private final float CONTENT_WEIGHT = 10f;
&nbsp;
&nbsp;    @Override
&nbsp;    public SearchHits&lt;PostDocument&gt; search(String search, int size, PostSort sort) {
&nbsp;        /**
&nbsp;         * 조건
&nbsp;         * 1. 제목 search 포함 : 가중치 +30
&nbsp;         * 2. 내용 search 포함 : 가중치 +10
&nbsp;         * 3. Elastic Search score 내림차순
&nbsp;         * 4. 점수 동일 시, like_cnt 내림차순
&nbsp;         * 5. score, like_cnt 동일 시 post_id 내림차순
&nbsp;         */
&nbsp;
&nbsp;
&nbsp;        //Criteria 생성하여 title 필드, content 필드에서 부분 일치 조건 + 가중치 지정
<b class="nc">&nbsp;        Criteria criteria=Criteria.where(&quot;title&quot;).matches(search).boost(TITLE_WEIGHT)</b>
<b class="nc">&nbsp;                .or(Criteria.where(&quot;content&quot;).matches(search).boost(CONTENT_WEIGHT));</b>
<b class="nc">&nbsp;        CriteriaQuery booleanQuery=new CriteriaQuery(criteria);</b>
&nbsp;
<b class="nc">&nbsp;        NativeQueryBuilder builder = NativeQuery.builder()</b>
<b class="nc">&nbsp;                .withQuery(booleanQuery)</b>
&nbsp;                // sort: _score desc, likeCnt desc, postId desc
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.score(sc -&gt; sc.order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.field(f -&gt; f.field(&quot;likeCnt&quot;).order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.field(f -&gt; f.field(&quot;postId&quot;).order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withMaxResults(size);</b>
&nbsp;
&nbsp;        // search_after
<b class="nc">&nbsp;        if (sort != null) {</b>
<b class="nc">&nbsp;            builder.withSearchAfter(sortToList(sort));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        NativeQuery query = builder.build();</b>
<b class="nc">&nbsp;        return operations.search(query, PostDocument.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public SearchHits&lt;PostDocument&gt; suggestCompleteByKeyword(String keyword) {
<b class="nc">&nbsp;        NativeQuery nativeQuery=NativeQuery.builder()</b>
<b class="nc">&nbsp;                .withQuery(q-&gt;q.prefix(p-&gt;p</b>
<b class="nc">&nbsp;                        .field(&quot;title.keyword&quot;)</b>
<b class="nc">&nbsp;                        .value(keyword)</b>
&nbsp;                ))
<b class="nc">&nbsp;                .withMaxResults(5)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return operations.search(nativeQuery,PostDocument.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param search : 검색어 - 해시태그로 검색시
&nbsp;     * @param size : 요청 사이즈
&nbsp;     * @param sort : 정렬 기준
&nbsp;     * @return : 조건에 맞는 해시태그로 게시물 조회
&nbsp;     *           [ 정렬 기준 ]
&nbsp;     *           1. _score 내림차 순
&nbsp;     *           2. postId 내림차순
&nbsp;     *           3. likeCnt 내림차 순
&nbsp;     */
&nbsp;    @Override
&nbsp;    public SearchHits&lt;PostDocument&gt; searchByHashTag(String search, int size, PostSort sort) {
<b class="nc">&nbsp;        Criteria criteria=Criteria.where(&quot;hashTag&quot;).matches(search);</b>
<b class="nc">&nbsp;        CriteriaQuery boolQuery=new CriteriaQuery(criteria);</b>
&nbsp;
<b class="nc">&nbsp;        NativeQueryBuilder builder = NativeQuery.builder()</b>
<b class="nc">&nbsp;                .withQuery(boolQuery)</b>
&nbsp;                // sort: _score desc, modifiedAt desc, likeCnt desc
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.score(sc -&gt; sc.order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.field(f -&gt; f.field(&quot;likeCnt&quot;).order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withSort(SortOptions.of(s -&gt; s.field(f -&gt; f.field(&quot;postId&quot;).order(SortOrder.Desc))))</b>
<b class="nc">&nbsp;                .withMaxResults(size);</b>
&nbsp;
<b class="nc">&nbsp;        if (sort != null) {</b>
<b class="nc">&nbsp;            builder.withSearchAfter(sortToList(sort));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        NativeQuery query = builder.build();</b>
<b class="nc">&nbsp;        return operations.search(query, PostDocument.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 해시태그 기반 검색어 자동 완성
&nbsp;     * @param keyword 해시태그 검색어
&nbsp;     * @return 해시태그 조건에 맞는 자동 검색어 리스트 조회
&nbsp;     */
&nbsp;    @Override
&nbsp;    public SearchHits&lt;PostDocument&gt; suggestCompleteByHashTag(String keyword) {
<b class="nc">&nbsp;        NativeQuery nativeQuery = NativeQuery.builder()</b>
<b class="nc">&nbsp;                .withQuery(q -&gt; q.prefix(p -&gt; p</b>
<b class="nc">&nbsp;                        .field(&quot;hashTag&quot;)</b>
<b class="nc">&nbsp;                        .value(keyword)</b>
&nbsp;                ))
<b class="nc">&nbsp;                .withMaxResults(5)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return operations.search(nativeQuery,PostDocument.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * search_after용 리스트 반환
&nbsp;     */
&nbsp;    private List&lt;Object&gt; sortToList(PostSort sort) {
<b class="nc">&nbsp;        return List.of(sort._score(), sort.likeCnt(), sort.lastPostId());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-23 11:21</div>
</div>
</body>
</html>
